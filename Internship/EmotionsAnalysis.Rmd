---
title: "BEX3012 Project Analysis"
author: "Stephanie Kobakian"
date: "28 March 2017"
output: bookdown::pdf_document2
---


Emotions Analysis

```{r cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, cache=T)

library(tidyverse)
library(readr)
library(GGally)
library(gridExtra)
```

Data used:
ME: Microsoft's results, emotion data
SB: Skybiometry's results, emotion data
GE: Google's results, emotion data
GoogleFaces: The Set of Faces found by Google in the intital study

```{r}
#EmoM <-read_csv("data/EmotionsMerged.csv")
ME <- read_csv("data/MicrosoftEmotions.csv")
SB <- read_csv("data/SkybiometryEmotions.csv")
GE <- read_csv("SoftwareRequestScripts/GoogleClassifiedFaces.csv")
GF <- read_csv("data/GoogleFaces.csv")
#ALLmetaIMGnamed <- read.csv("ALLmetaIMGnamed.csv")

# ALLmetaIMGnamedFaces<-ALLmetaIMGnamed%>%
#   filter(matchesManual)%>%
#   dplyr::select(-ID, -facecounter)%>%
#   mutate(fileID = as.numeric(factor(file))) %>%
#   mutate(FaceKey=paste(fileID, boxID, sep="-")) %>%
#   mutate(FaceID=paste(fileID, boxID, substring(type, 1,2), sep="-")) %>%
#   mutate(FileName=paste("face-", FaceID, ".png", sep=""))


#EmotionsMerged<-left_join(by="FileName", MicrosoftEmotions, ALLmetaIMGnamedFaces)
#EmotionsMerged<-write.csv(EmotionsMerged, "EmotionsMerged.csv", row.names = FALSE)


#EmotionsMerged<-EmotionsMerged %>% mutate(s = sum(anger, contempt, disgust, fear, happiness, neutral, sadness, surprise, na.rm=TRUE))

```


Connect face id to original Google set
```{r}
GEsub <- GE[,c(1, 10:13, 17:24)]

GE1 <- GEsub %>% 
  rowwise() %>%
  mutate(minX = pmin(cbind(boundingPoly.x1, boundingPoly.x4)), 
         maxX = pmin(cbind(boundingPoly.x2, boundingPoly.x3)),
         minY = pmin(cbind(boundingPoly.y1, boundingPoly.y2)), 
         maxY = pmin(cbind(boundingPoly.y3, boundingPoly.y4))) %>%
  ungroup()

GE1 <- GE1[,c(1:5, 14:17)]
```


Add meta data to Emotion results
```{r}
GE <- left_join(GF, GE1, by = c("file","minX","maxX","minY","maxY"))

ME <- left_join(ME, GF, by = "FileName") 
SB <- left_join(SB, GF, by = c("aname"="FileName")) 
```


Create normalized SB values
```{r}
SB<-SB %>%
  rowwise %>% mutate(z = (anger.confidence+
               disgust.confidence+
               fear.confidence+
               happiness.confidence+
               neutral_mood.confidence+
               sadness.confidence+
               surprise.confidence))
 
SB<-SB %>%
  mutate(anger = anger.confidence/z,
         disgust = disgust.confidence/z,
         fear = fear.confidence/z,
         happiness = happiness.confidence/z,
         neutral = neutral_mood.confidence/z,
         sadness = sadness.confidence/z,
         surprise = surprise.confidence/z)
```


Create normalized GE values
GE: Google results of player facial emotions in numeric confidences

```{r}
Conf <- function(Emot){
ifelse(Emot=="VERY_UNLIKELY", 10,  
        ifelse(Emot == "UNLIKELY", 30, 
                ifelse(Emot == "POSSIBLE", 50, 
                ifelse(Emot == "LIKELY", 70, 
                ifelse(Emot == "VERY_LIKELY", 90, NA)))))
}
  
GE <- GE %>% mutate(joyConf = Conf(joyLikelihood)) %>%
  mutate(sorrowConf = Conf(sorrowLikelihood)) %>%
  mutate(angerConf = Conf(angerLikelihood)) %>%
  mutate(surpriseConf = Conf(surpriseLikelihood))

GE <- GE %>%
  rowwise %>% 
  mutate(neutralConf = 100 - (pmax(joyConf, sorrowConf, angerConf, surpriseConf))) %>%
  mutate(z = (joyConf+sorrowConf+angerConf+surpriseConf+neutralConf)) %>%
  mutate(anger = angerConf/z,
         joy = joyConf/z,
         neutral = neutralConf/z,
         sorrow = sorrowConf/z,
         surprise = surpriseConf/z)

```




Convert to true or false emotion values

```{r}

ME <- ME %>% mutate(HappinessTF = ifelse(happiness > 0.5,TRUE,FALSE)) %>%
             mutate(SadnessTF = ifelse(sadness > 0.5,TRUE,FALSE))%>%
             mutate(AngerTF = ifelse(anger > 0.5,TRUE,FALSE))%>%
             mutate(FearTF = ifelse(fear > 0.5,TRUE,FALSE))%>%
             mutate(SurpriseTF = ifelse(surprise > 0.5,TRUE,FALSE))

# 
GE <- GE %>%
  mutate(JoyTF = ifelse((joyLikelihood=="LIKELY"|joyLikelihood=="VERY_LIKELY"), TRUE,FALSE)) %>%
  mutate(SorrowTF = ifelse((sorrowLikelihood=="LIKELY"|sorrowLikelihood=="VERY_LIKELY"), TRUE,FALSE))%>%
  mutate(AngerTF = ifelse((angerLikelihood=="LIKELY"|angerLikelihood=="VERY_LIKELY"), TRUE,FALSE))%>%
  mutate(SurpriseTF = ifelse((surpriseLikelihood=="LIKELY"|surpriseLikelihood=="VERY_LIKELY"), TRUE,FALSE))


GE <- GE %>% subset(!duplicated(GE$FaceID))

SB <- SB %>% mutate(HappinessTF = ifelse(happiness > 0.5,TRUE,FALSE)) %>%
  mutate(SadnessTF = ifelse(sadness > 0.5,TRUE,FALSE))%>%
  mutate(AngerTF = ifelse(anger > 0.5,TRUE,FALSE))%>%
  mutate(FearTF = ifelse(fear > 0.5,TRUE,FALSE))%>%
  mutate(SurpriseTF = ifelse(surprise > 0.5,TRUE,FALSE)) %>%
  mutate(NeutralTF = ifelse(neutral > 0.5,TRUE,FALSE))
```

Parallel coordinate plots
```{r}
#p1 <- ggparcoord(data = set1, columns = 2:9, groupColumn="file", order = "allClass")

#p2 <- ggparcoord(data = set2, columns = 2:9, groupColumn="file", order = "allClass")

#p3 <- ggparcoord(data = set3, columns = 2:9, groupColumn="file", order = "allClass")
```



Consider just players,
GEP: Microsoft's results, emotion data for only players
MEP: Skybiometry's results, emotion data for only players
SBP: Google's results, emotion data for only players
```{r}
GEP <- GE %>% filter(detect=="Player")
MEP <- ME %>% filter(detect=="Player")
SBP <- SB %>% filter(detect=="Player")

GFP <- GF %>% filter(detect=="Player")

MEP$anger %>% is.na() %>% sum
SBP$anger %>% is.na() %>% sum
```


Skybiometry Emotion plots

```{r}

ggSBPne <- ggplot(SBP, aes(x=neutral))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggSBne <- ggplot(SB, aes(x=neutral))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))


ggSBPan <- ggplot(SBP, aes(x=anger))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggSBPdi <- ggplot(SBP, aes(x=disgust))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggSBPfe <- ggplot(SBP, aes(x=fear))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggSBPha <- ggplot(SBP, aes(x=happiness))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggSBPsa <- ggplot(SBP, aes(x=sadness))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggSBPsu <- ggplot(SBP, aes(x=surprise))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))


grid.arrange(ggSBPne,
             ggSBPan,
             ggSBPdi,
             ggSBPfe,
             ggSBPha,
             ggSBPsa,
             ggSBPsu, nrow=3)

```


SBPCL: Long form of Confidence levels of SB results
```{r}
SBPCL <- SBP %>% group_by(aname) %>% 
  gather(key = Emotion, value=EmotionValue, anger,disgust,fear,happiness,neutral,sadness,surprise)

  
SBPCL1 <- SBPCL %>% arrange(aname,desc(EmotionValue)) %>%
      group_by_(~ aname) %>% 
      slice(1)

table(SBPCL1$Emotion)

ggplot(SBPCL, aes(x=Emotion, y=EmotionValue)) + theme(axis.text.x = element_text(angle = 20)) + geom_boxplot()

#ggscatmat(as.data.frame(na.omit(SBEmotions[,3:9])))

```

GEP: Long form of Confidence levels of GE results
GEPN:  Long form of Confidence levels of GE results renamed to match
```{r}
#rename
GEPN <- GEP %>% select(FileName, anger, happiness=joy, sadness=sorrow, surprise, neutral, everything())


GEPCL <- GEPN %>% group_by(FileName) %>% 
  gather(key = Emotion, value=EmotionValue, anger, happiness, sadness, surprise, neutral)

GEPCL1 <- GEPCL %>% arrange(FileName,desc(EmotionValue)) %>%
      group_by_(~ FileName) %>% 
      slice(1)

table(GEPCL1$Emotion)

ggplot(GEPCL1, aes(x=Emotion, y=EmotionValue)) + theme(axis.text.x = element_text(angle = 20)) + geom_boxplot()

#ggscatmat(as.data.frame(na.omit(SBEmotions[,3:9])))

```



Microsoft Emotion plots
```{r}
ggMEPne<-ggplot(MEP, aes(x=neutral))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggMEPan<-ggplot(MEP, aes(x=anger))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggMEPdi<-ggplot(MEP, aes(x=disgust))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggMEPfe<-ggplot(MEP, aes(x=fear))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggMEPha<-ggplot(MEP, aes(x=happiness))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggMEPsa<-ggplot(MEP, aes(x=sadness))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))
ggMEPsu<-ggplot(MEP, aes(x=surprise))+geom_histogram(bins=15) +coord_cartesian(xlim = c(0, 1))

grid.arrange(ggMEPne,
             ggMEPan,
             ggMEPdi,
             ggMEPfe,
             ggMEPha,
             ggMEPsa,
             ggMEPsu, nrow=3)

```


Microsoft Long form 
MEPCL: Long form of Confidence levels of ME results
```{r}
MEPCL<-MEP %>% group_by(FileName) %>% 
  gather(key = Emotion, value=EmotionValue, anger,contempt,disgust,fear,happiness,neutral,sadness,surprise) 

MEPCL1 <- MEPCL %>% arrange(FileName, desc(EmotionValue)) %>%
      group_by_(~ FileName) %>% 
      slice(1)


ggplot(MEPCL, aes(x=Emotion, y=EmotionValue))+geom_boxplot()


table(MEPCL1$Emotion)
```



Tables
```{r}
# 
# table(ME$HappinessTF)
# 
# table(ME$HappinessTF, GE$JoyTF)
# 
# table(SB$HappinessTF, ME$HappinessTF)
# 
# table(MEL1$Emotion)
# table(SB$mood.value)
# table(MEL1$Emotion, SB$mood.value)

```



###
Join emotions for each face
```{r}
S1 <- select(SBPCL1, FileName = aname , SEmotion = Emotion)
S2 <- select(MEPCL1, FileName, MEmotion = Emotion)
S3 <- select(GEPCL1, FileName, GEmotion = Emotion)
J1 <- full_join(S1, S2, by = "FileName")
J2 <- full_join(J1, S3, by = "FileName")

PS1 <- J2 %>% filter(SEmotion==MEmotion|SEmotion==GEmotion|MEmotion==GEmotion)
nrow(PS1)


J2L<-J2 %>% 
  gather(key = Software, value = Emotion, SEmotion, MEmotion, GEmotion)


ggplot(J2L, aes(x=Emotion)) + geom_bar(aes(fill = Software), position = "dodge")



```



Contingency Table of 50 image sample

```{r}
set.seed(300)
J2na<-na.omit(J2)
FL<-sample(J2na$FileName, 50)
J2na<-J2na %>% subset(FileName %in% FL)

ct<-table(J2na$SEmotion, J2na$MEmotion, J2na$GEmotion)
ftable(ct)

```


Plot images and compare to emotion data
```{r}
# for (i in 1:50){
# 
#   devAskNewPage()
#   plot(load.image(paste0("Faces/", J2na$FileName[i])), main = paste0( J2na$FileName[i]))
# 
# }

SER<-read_csv("SampleEmotionResults.csv")

t1<-table(SER$Manual, SER$SEmotion)
ftable(t1)

```

Find images from matches played by certain players
```{r}
a <- as.data.frame(table(GEP$player1))
a <- a %>% arrange(-Freq)


b <- as.data.frame(table(GEP$player2))
b <- b %>% arrange(-Freq)

PJ <- full_join(a, b, by = "Var1")

PJ$Freq.x<-ifelse(!is.na(PJ$Freq.x), PJ$Freq.x, 0) 
PJ$Freq.y<-ifelse(!is.na(PJ$Freq.y), PJ$Freq.y, 0) 
PJ$sum<-PJ$Freq.x+PJ$Freq.y
```


Player Subsetting
```{r}
#Create column for Player Names
#GoogleFaces$PlayerName<-NA


# PlayerSubset <- function(PlayerName, data = GF1) {
#   
#   PlayerSet<-filter(data, player1==PlayerName | player2==PlayerName)
#   
#   return(as.list(PlayerSet$FileName))
# }
  
# 
# MSlist <- PlayerSubset("MSakkari")
# MSlist


MSimgsG<-GEPCL1 %>% filter(player1=="ARadwanska")
MSimgsG <-MSimgsG %>% filter(detect=="Player")
MSlist <- as.list(MSimgsG$FileName)
length(MSlist)

library(imager)
DisplayFaces <- function(list) {
for (i in 1:length(list)){

   devAskNewPage()
   plot(load.image(paste0("Faces/", list[i])), 
        main = paste0(i, list[i]))
 
}
}

```


subset of Google where neutral = another category
```{r}
neutrals <- GEPCL1 %>% filter(neutralConf==joyConf | 
                    neutralConf==sorrowConf | 
                    neutralConf==surpriseConf | 
                    neutralConf==angerConf) %>%
  filter(neutralConf != 10)





```


Emotive Player Faces
EF: Emotive Player Faces to be used as sample.
It is hard to classify many of the faces as one of the seven possible options. Where hints of emotive expressions can be attributed to one or more faces
```{r}

EF <- as.list(c("face-70-1-Go.png", "face-227-2-Go.png", "face-399-1-Go.png",
        "face-450-1-Go.png", "face-475-1-Go.png", "face-626-1-Go.png",
        "face-730-1-Go.png", "face-762-1-Go.png", "face-781-1-Go.png",
        "face-790-1-Go.png", "face-801-1-Go.png", "face-816-1-Go.png",
        "face-945-1-Go.png", "face-947-1-Go.png", "face-1128-1-Go.png",
        "face-1173-1-Go.png", "face-1230-1-Go.png", "face-1355-1-Go.png",
        "face-1635-1-Go.png", "face-1764-1-Go.png"))

DisplayFaces(EF)
```




Player Emotion Tables

