---
title: "BEX3012 Project Analysis"
author: "Stephanie Kobakian"
date: "28 March 2017"
output: bookdown::pdf_document2
---


Emotions Analysis

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, cache=T)

library(tidyverse)
library(readr)
library(GGally)
library(gridExtra)
```

Data used:
ME: Microsoft's results, emotion data
SB: Skybiometry's results, emotion data
GE: Google's results, emotion data
GoogleFaces: The Set of Faces found by Google in the intital study

```{r readdata}
#EmoM <-read_csv("data/EmotionsMerged.csv")
ME <- read_csv("data/MicrosoftEmotions.csv")
SB <- read_csv("data/SkybiometryEmotions.csv")
GE <- read_csv("data/GoogleFacesEmotions.csv")
GF <- read_csv("data/GoogleFaces.csv")
#ALLmetaIMGnamed <- read.csv("ALLmetaIMGnamed.csv")

# ALLmetaIMGnamedFaces<-ALLmetaIMGnamed%>%
#   filter(matchesManual)%>%
#   dplyr::select(-ID, -facecounter)%>%
#   mutate(fileID = as.numeric(factor(file))) %>%
#   mutate(FaceKey=paste(fileID, boxID, sep="-")) %>%
#   mutate(FaceID=paste(fileID, boxID, substring(type, 1,2), sep="-")) %>%
#   mutate(FileName=paste("face-", FaceID, ".png", sep=""))


#EmotionsMerged<-left_join(by="FileName", MicrosoftEmotions, ALLmetaIMGnamedFaces)
#EmotionsMerged<-write.csv(EmotionsMerged, "EmotionsMerged.csv", row.names = FALSE)


#EmotionsMerged<-EmotionsMerged %>% mutate(s = sum(anger, contempt, disgust, fear, happiness, neutral, sadness, surprise, na.rm=TRUE))


#Create column for Player Names
#GF$PlayerNumber<-NA


# PlayerSubset <- function(PlayerName, data = GF1) {
#   
#   PlayerSet<-filter(data, player1==PlayerName | player2==PlayerName)
#   
#   return(as.list(PlayerSet$FileName))
# }
  
# 
# MSlist <- PlayerSubset("MSakkari")
# MSlist

GF <- GF %>% rowwise %>%
  mutate(playerName = ifelse(PlayerNumber == 1, player1,
                                            ifelse(PlayerNumber == 2, player2,
                                                   ifelse(is.na(PlayerNumber), NA, NA))))

GE <- GE %>% rowwise %>%
  mutate(playerName = ifelse(PlayerNumber == 1, player1,
                                            ifelse(PlayerNumber == 2, player2,
                                                   ifelse(is.na(PlayerNumber), NA, NA))))

```


Connect face id to original Google set
```{r googleSubset}
# GEsub <- GE[,c(1, 10:13, 17:24)]
# 
# GE1 <- GEsub %>% 
#   rowwise() %>%
#   mutate(minX = pmin(cbind(boundingPoly.x1, boundingPoly.x4)), 
#          maxX = pmin(cbind(boundingPoly.x2, boundingPoly.x3)),
#          minY = pmin(cbind(boundingPoly.y1, boundingPoly.y2)), 
#          maxY = pmin(cbind(boundingPoly.y3, boundingPoly.y4))) %>%
#   ungroup()
# 
# GE1 <- GE1[,c(1:5, 14:17)]
```


Add meta data to Emotion results
```{r mergeEmotMeta}
#GE <- left_join(GF, GE1, by = c("file","minX","maxX","minY","maxY"))

ME <- left_join(ME, GF, by = "FileName") 
SB <- left_join(SB, GF, by = c("aname"="FileName")) 
```


Create normalized SB values
```{r normaliseSB}
SB<-SB %>%
  rowwise %>% mutate(z = (anger.confidence+
               disgust.confidence+
               fear.confidence+
               happiness.confidence+
               neutral_mood.confidence+
               sadness.confidence+
               surprise.confidence))
 
SB<-SB %>%
  mutate(anger = anger.confidence/z,
         disgust = disgust.confidence/z,
         fear = fear.confidence/z,
         happiness = happiness.confidence/z,
         neutral = neutral_mood.confidence/z,
         sadness = sadness.confidence/z,
         surprise = surprise.confidence/z)
```


Create normalized GE values
GE: Google results of player facial emotions in numeric confidences

```{r normaliseGE}
Conf <- function(Emot){
ifelse(Emot=="VERY_UNLIKELY", 10,  
        ifelse(Emot == "UNLIKELY", 30, 
                ifelse(Emot == "POSSIBLE", 50, 
                ifelse(Emot == "LIKELY", 70, 
                ifelse(Emot == "VERY_LIKELY", 90, NA)))))
}
  
GE <- GE %>% mutate(joyConf = Conf(joyLikelihood)) %>%
  mutate(sorrowConf = Conf(sorrowLikelihood)) %>%
  mutate(angerConf = Conf(angerLikelihood)) %>%
  mutate(surpriseConf = Conf(surpriseLikelihood))

GE <- GE %>%
  rowwise %>% 
  mutate(neutralConf = 100 - (pmax(joyConf, sorrowConf, angerConf, surpriseConf))) %>%
  mutate(z = (joyConf+sorrowConf+angerConf+surpriseConf+neutralConf)) %>%
  mutate(anger = angerConf/z,
         joy = joyConf/z,
         neutral = neutralConf/z,
         sorrow = sorrowConf/z,
         surprise = surpriseConf/z)

```


Convert to true or false emotion values

```{r TFemotions}

ME <- ME %>% mutate(HappinessTF = ifelse(happiness > 0.5,TRUE,FALSE)) %>%
             mutate(SadnessTF = ifelse(sadness > 0.5,TRUE,FALSE))%>%
             mutate(AngerTF = ifelse(anger > 0.5,TRUE,FALSE))%>%
             mutate(FearTF = ifelse(fear > 0.5,TRUE,FALSE))%>%
             mutate(SurpriseTF = ifelse(surprise > 0.5,TRUE,FALSE))

# 
GE <- GE %>%
  mutate(JoyTF = ifelse((joyLikelihood=="LIKELY"|joyLikelihood=="VERY_LIKELY"), TRUE,FALSE)) %>%
  mutate(SorrowTF = ifelse((sorrowLikelihood=="LIKELY"|sorrowLikelihood=="VERY_LIKELY"), TRUE,FALSE))%>%
  mutate(AngerTF = ifelse((angerLikelihood=="LIKELY"|angerLikelihood=="VERY_LIKELY"), TRUE,FALSE))%>%
  mutate(SurpriseTF = ifelse((surpriseLikelihood=="LIKELY"|surpriseLikelihood=="VERY_LIKELY"), TRUE,FALSE))


GE <- GE %>% subset(!duplicated(GE$FaceID))

SB <- SB %>% mutate(HappinessTF = ifelse(happiness > 0.5,TRUE,FALSE)) %>%
  mutate(SadnessTF = ifelse(sadness > 0.5,TRUE,FALSE))%>%
  mutate(AngerTF = ifelse(anger > 0.5,TRUE,FALSE))%>%
  mutate(FearTF = ifelse(fear > 0.5,TRUE,FALSE))%>%
  mutate(SurpriseTF = ifelse(surprise > 0.5,TRUE,FALSE)) %>%
  mutate(NeutralTF = ifelse(neutral > 0.5,TRUE,FALSE))
```


Consider just players,
GEP: Microsoft's results, emotion data for only players
MEP: Skybiometry's results, emotion data for only players
SBP: Google's results, emotion data for only players
```{r playerSubset}
GEP <- GE %>% filter(detect=="Player")
MEP <- ME %>% filter(detect=="Player")
SBP <- SB %>% filter(detect=="Player")

GFP <- GF %>% filter(detect=="Player")

MEP$anger %>% is.na() %>% sum
SBP$anger %>% is.na() %>% sum
```


Skybiometry Emotion plots

```{r SBhists}
plotSBHists<-function(data) {
ggne <- ggplot(data, aes(x=neutral))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
ggan <- ggplot(data, aes(x=anger))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
ggdi <- ggplot(data, aes(x=disgust))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
ggfe <- ggplot(data, aes(x=fear))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
ggha <- ggplot(data, aes(x=happiness))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
ggsa <- ggplot(data, aes(x=sadness))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
ggsu <- ggplot(data, aes(x=surprise))+geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))

grid.arrange(ggne,ggan,ggdi,ggfe,ggha,ggsa,ggsu,nrow=3)
}

plotEmotion<-function(data, Emotion) {
ggEmot <- ggplot(data, aes_string(x=Emotion))+geom_histogram(binwidth=0.025) +coord_cartesian(xlim = c(0, 1), ylim = c(0,300))
}


```


SBPCL: Long form of Confidence levels of SB results
```{r SBPlong}
SBPCL <- SBP %>% group_by(aname) %>% 
  gather(key = Emotion, value=EmotionValue, anger,disgust,fear,happiness,neutral,sadness,surprise)

  
SBPCL1 <- SBPCL %>% arrange(aname,desc(EmotionValue)) %>%
      group_by_(~ aname) %>% 
      slice(1)

table(SBPCL1$Emotion)

ggplot(SBPCL, aes(x=Emotion, y=EmotionValue)) + theme(axis.text.x = element_text(angle = 20)) + geom_boxplot()

#ggscatmat(as.data.frame(na.omit(SBEmotions[,3:9])))

```

GEP: Long form of Confidence levels of GE results
GEPN:  Long form of Confidence levels of GE results renamed to match
```{r GEPlong}
#rename
GEPN <- GEP %>% select(FileName, anger, happiness=joy, sadness=sorrow, surprise, neutral, everything())


GEPCL <- GEPN %>% group_by(FileName) %>% 
  gather(key = Emotion, value=EmotionValue, anger, happiness, sadness, surprise, neutral)

GEPCL1 <- GEPCL %>% arrange(FileName,desc(EmotionValue)) %>%
      group_by_(~ FileName) %>% 
      slice(1)

table(GEPCL1$Emotion)

ggplot(GEPCL1, aes(x=Emotion, y=EmotionValue)) + theme(axis.text.x = element_text(angle = 20)) + geom_boxplot()

#ggscatmat(as.data.frame(na.omit(SBEmotions[,3:9])))

```



Microsoft Emotion plots
```{r MEhists}
plotMEHists<-function(data) {
ggMEPne<-ggplot(MEP, aes(x=neutral)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPan<-ggplot(MEP, aes(x=anger)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPdi<-ggplot(MEP, aes(x=disgust)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPfe<-ggplot(MEP, aes(x=fear)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPha<-ggplot(MEP, aes(x=happiness)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPsa<-ggplot(MEP, aes(x=sadness)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPsu<-ggplot(MEP, aes(x=surprise)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))
ggMEPco<-ggplot(MEP, aes(x=contempt)) + geom_histogram(binwidth=0.055) +coord_cartesian(xlim = c(0, 1), ylim = c(0,420))

grid.arrange(ggMEPne,
             ggMEPan,
             ggMEPdi,
             ggMEPfe,
             ggMEPha,
             ggMEPsa,
             ggMEPsu, 
             ggMEPco,nrow=3)
}


```


Microsoft Long form 
MEPCL: Long form of Confidence levels of ME results
```{r MElong}
MEPCL<-MEP %>% group_by(FileName) %>% 
  gather(key = Emotion, value=EmotionValue, anger,contempt,disgust,fear,happiness,neutral,sadness,surprise) 

MEPCL1 <- MEP %>% group_by(FileName) %>% 
  gather(key = Emotion, value=EmotionValue, anger,contempt,disgust,fear,happiness,neutral,sadness,surprise)  %>% 
  arrange(FileName, desc(EmotionValue)) %>%
      group_by_(~ FileName) %>% 
      slice(1)


ggplot(MEPCL, aes(x=Emotion, y=EmotionValue))+geom_boxplot()


table(MEPCL1$Emotion)
```



Tables
```{r}
# 
# table(ME$HappinessTF)
# 
# table(ME$HappinessTF, GE$JoyTF)
# 
# table(SB$HappinessTF, ME$HappinessTF)
# 
# table(MEL1$Emotion)
# table(SB$mood.value)
# table(MEL1$Emotion, SB$mood.value)

```



###
Join emotions for each face
J2: Table of FileNames and associated dominant emotion
```{r combined}
S1 <- select(SBP1, FileName = aname , SEmotion = Emotion)
S2 <- select(MEP1, FileName, MEmotion = Emotion)
S3 <- select(GEP1, FileName, GEmotion = Emotion)
J1 <- full_join(S1, S2, by = "FileName")
J2 <- full_join(J1, S3, by = "FileName")

PS1 <- J2 %>% filter(SEmotion==MEmotion|SEmotion==GEmotion|MEmotion==GEmotion)
nrow(PS1)


J2L <- J2 %>% 
  gather(key = Software, value = Emotion, SEmotion, MEmotion, GEmotion)


ggplot(J2L, aes(x=Emotion)) + geom_bar(aes(fill = Software), position = "dodge")


```



Contingency Table of 50 image sample

```{r table}
set.seed(300)
J2na<-na.omit(J2)
FL<-sample(J2na$FileName, 50)
J2na<-J2na %>% subset(FileName %in% FL)

ct<-table(J2na$SEmotion, J2na$MEmotion, J2na$GEmotion)
ftable(ct)

```


Plot images and compare to emotion data
```{r}
# for (i in 1:50){
# 
#   devAskNewPage()
#   plot(load.image(paste0("Faces/", J2na$FileName[i])), main = paste0( J2na$FileName[i]))
# 
# }

SER<-read_csv("Figures/SampleEmotionResults.csv")

t1<-table(SER$Manual, SER$SEmotion)
ftable(t1)

```

Find images from matches played by certain players
```{r playerMatches}
a <- as.data.frame(table(GEP$player1))
a <- a %>% arrange(-Freq)


b <- as.data.frame(table(GEP$player2))
b <- b %>% arrange(-Freq)

PJ <- full_join(a, b, by = "Var1")

PJ$Freq.x<-ifelse(!is.na(PJ$Freq.x), PJ$Freq.x, 0) 
PJ$Freq.y<-ifelse(!is.na(PJ$Freq.y), PJ$Freq.y, 0) 
PJ$sum<-PJ$Freq.x+PJ$Freq.y
```


Player Subsetting
```{r DisplayFaces}
AKimgsG<-GEP %>% filter(player1=="JSousa")
AKimgsG<-AKimgsG %>% filter(detect=="Player")
AKlist <- as.list(AKimgsG$FileName)
length(AKlist)

DisplayFaces(AKlist)

library(imager)
DisplayFaces <- function(list) {
    for (i in 1:15){

   devAskNewPage()
   plot(load.image(paste0("Faces/", list[i])), 
        main = paste0(i, list[i]))
 
}
}

```


subset of Google where neutral = another category
```{r GoogleNeutral}
neutrals <- GEPCL1 %>% filter(neutralConf==joyConf | 
                    neutralConf==sorrowConf | 
                    neutralConf==surpriseConf | 
                    neutralConf==angerConf) %>%
  filter(neutralConf != 10)





```


Emotive Player Faces
EF: Emotive Player Faces to be used as sample.
It is hard to classify many of the faces as one of the seven possible options. Where hints of emotive expressions can be attributed to one or more faces
```{r EmotiveFaces}

EF <- as.list(c("face-70-1-Go.png", "face-227-2-Go.png", "face-399-1-Go.png",
        "face-450-1-Go.png", "face-475-1-Go.png", "face-626-1-Go.png",
        "face-730-1-Go.png", "face-762-1-Go.png", "face-781-1-Go.png",
        "face-790-1-Go.png", "face-801-1-Go.png", "face-816-1-Go.png",
        "face-945-1-Go.png", "face-947-1-Go.png", "face-1128-1-Go.png",
        "face-1173-1-Go.png", "face-1230-1-Go.png", "face-1355-1-Go.png",
        "face-1635-1-Go.png", "face-1764-1-Go.png"))

DisplayFaces(EF)
```



Player Emotion Tables
Distribution of emotion values for particular emotions across all images of a player
```{r PlayerHists}
ggplot(na.omit(SBP), aes(x=playerName))+geom_bar()+ theme(axis.text.x = element_text(angle = 20)) 

Name <- "GSimon"

EmotionHists <- function(Emotion, Name){
  
  SBPplayer <- SBP %>% filter(playerName == Name)
  
  ggSBPan <- 
    ggplot(SBPplayer, aes_string(x = Emotion)) + ggtitle("Skybiometry") +
    geom_histogram(binwidth = 0.05) + coord_cartesian(xlim = c(0, 1))
  
  GEPplayer <- GEPN %>% filter(playerName == Name)
  
  ggGEPan <-
    ggplot(GEPplayer, aes_string(x = Emotion)) +  ggtitle("Google") +
    geom_histogram(binwidth = 0.05) + coord_cartesian(xlim = c(0, 1))
  
  MEPplayer <- MEP %>% filter(playerName == Name)
  
  ggMEPan <-
    ggplot(MEPplayer, aes_string(x = Emotion)) +  ggtitle("Microsoft") +
    geom_histogram(binwidth = 0.05) + coord_cartesian(xlim = c(0, 1))


grid.arrange(ggMEPan,ggSBPan,ggGEPan, nrow = 3) 
}

EmotionHists(Emotion = "anger", "GSimon")
EmotionHists(Emotion = "surprise", "GSimon")
EmotionHists(Emotion = "happiness", "GSimon")
EmotionHists(Emotion = "sadness", "GSimon")


```



Neutrality in Faces
```{r}
sum(MEPCL1$Emotion=="neutral")/nrow(MEPCL1)
sum(SBPCL1$Emotion=="neutral")/nrow(SBPCL1)
sum(GEPCL1$Emotion=="neutral")/nrow(GEPCL1)

nrow(MEPCL1)-sum(MEPCL1$Emotion=="neutral")
nrow(SBPCL1)-sum(SBPCL1$Emotion=="neutral")
nrow(GEPCL1)-sum(GEPCL1$Emotion=="neutral")

```

Pairwise comparison of neutral overlaps
```{r neutrality}
J2ne<-J2 %>% rowwise() %>%
  mutate(SEneutral = ifelse(SEmotion=="neutral", "neutral","non-neutral")) %>%
  mutate(MEneutral = ifelse(MEmotion=="neutral", "neutral","non-neutral")) %>%
  mutate(GEneutral = ifelse(GEmotion=="neutral", "neutral","non-neutral")) 

S4 <- select(SBP, FileName = aname, Skybiometry = neutral)
S5 <- select(MEP, FileName, Microsoft = neutral)
S6 <- select(GEP, FileName, Google = neutral)
J3 <- full_join(S4, S5, by = "FileName")
J4 <- full_join(J3, S6, by = "FileName")

J4 <- J4 %>% rowwise %>% mutate(GoogleJitter = jitter(Google)) 

library(GGally)
ggscatmat(as.data.frame(na.omit(J4[,c(2:3,5)])))


table(J2ne$MEmotion, J2$GEmotion)
table(J2ne$MEneutral, J2ne$GEneutral)
```


Bar chart of attributes for neutral categorisations
Need to consider that higher levels of values across the population may create misleading plots.

```{r}
Gneutral <- GEPCL1 %>% filter(Emotion=="neutral")
Mneutral <- MEPCL1 %>% filter(Emotion=="neutral")
Sneutral <- SBPCL1 %>% filter(Emotion=="neutral")


NeutralBars <- function(Attribute){
  
  ggSBPne <- 
    ggplot(Sneutral, aes_string(x = Attribute)) + ggtitle("Skybiometry") +
    geom_bar()
  
  ggGEPne <-
    ggplot(Gneutral, aes_string(x = Attribute)) + ggtitle("Google") +
    geom_bar()
  
  ggMEPne <-
    ggplot(Mneutral, aes_string(x = Attribute)) + ggtitle("Microsoft") +
    geom_bar()

grid.arrange(ggMEPne,ggSBPne,ggGEPne, nrow = 3) 
}

NeutralBars(Attribute = "bg")
```



```{r}
#Find missing player
nrow(GEP)
nrow(MEP)
nrow(SBP)

dupe <- subset(duplicated(SBP$aname))
duplicated(SBP$aname)
SBP[264,]
SBP %>% View()
```


``` {r playerSpecificEmotions}
player <- "AMurray"
GEPAM <- GEP %>% filter(playerName == player)
MEPAM <- MEP %>% filter(playerName == player)
SBPAM <- SBP %>% filter(playerName == player)




```